<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cartera Acciones Chile — MVP</title>
    <style>
      :root {
        color-scheme: light;
        --bg: #ffffff;
        --text: #111111;
        --muted: #666666;
        --border: #eaeaea;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        padding: 40px 20px;
        background: var(--bg);
        color: var(--text);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial,
          sans-serif;
        line-height: 1.45;
      }

      .container {
        max-width: 1080px;
        margin: 0 auto;
      }

      h1 {
        margin: 0 0 24px;
        font-size: clamp(1.4rem, 2.5vw, 2rem);
        font-weight: 600;
        letter-spacing: -0.02em;
      }

      .grid {
        display: grid;
        grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
        gap: 20px;
      }

      .panel {
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 20px;
        background: #fff;
      }

      form {
        display: grid;
        gap: 14px;
      }

      label {
        display: grid;
        gap: 6px;
        font-size: 0.9rem;
        font-weight: 500;
      }

      input,
      select,
      textarea,
      button {
        width: 100%;
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 12px;
        background: #fff;
        color: var(--text);
        font: inherit;
      }

      textarea {
        min-height: 92px;
        resize: vertical;
      }

      input:focus,
      select:focus,
      textarea:focus,
      button:focus {
        outline: 2px solid #000;
        outline-offset: 1px;
      }

      button {
        cursor: pointer;
        font-weight: 600;
      }

      button[disabled] {
        cursor: not-allowed;
        opacity: 0.6;
      }

      .status {
        min-height: 20px;
        margin: 8px 0 0;
        font-size: 0.85rem;
      }

      .status.error {
        color: #000;
        font-weight: 600;
      }

      .output-box {
        margin: 0;
        min-height: 420px;
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 16px;
        overflow-x: auto;
      }

      .section {
        margin-bottom: 16px;
      }

      .section:last-child {
        margin-bottom: 0;
      }

      .section-title {
        margin: 0 0 6px;
        font-size: 0.86rem;
        letter-spacing: 0.03em;
        text-transform: uppercase;
        font-weight: 600;
      }

      p,
      li,
      td,
      th {
        font-size: 0.92rem;
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      th,
      td {
        border: 1px solid var(--border);
        text-align: left;
        padding: 8px;
        vertical-align: top;
      }

      th {
        font-weight: 600;
      }

      ol {
        margin: 0;
        padding-left: 20px;
      }

      .muted {
        color: var(--muted);
      }

      .disclaimer {
        margin: 12px 0 0;
        font-size: 0.8rem;
        color: var(--muted);
      }

      @media (max-width: 840px) {
        body {
          padding: 24px 14px;
        }

        .grid {
          grid-template-columns: 1fr;
        }

        .output-box {
          min-height: 320px;
        }
      }
    </style>
  </head>
  <body>
    <main class="container">
      <h1>Cartera Acciones Chile — MVP</h1>

      <section class="grid">
        <article class="panel">
          <form id="portfolioForm">
            <label>
              Capital (CLP)
              <input id="capital" name="capital" type="number" min="1" step="1" required />
            </label>

            <label>
              Horizonte de inversión (años)
              <input id="horizon" name="horizon" type="number" min="1" step="1" required />
            </label>

            <label>
              Nivel de riesgo
              <select id="risk" name="risk" required>
                <option value="">Selecciona nivel</option>
                <option value="Bajo">Bajo</option>
                <option value="Medio">Medio</option>
                <option value="Medio-Alto">Medio-Alto</option>
                <option value="Alto">Alto</option>
              </select>
            </label>

            <label>
              Objetivo
              <input id="objective" name="objective" type="text" maxlength="200" required />
            </label>

            <label>
              Restricciones opcionales
              <textarea id="constraints" name="constraints" maxlength="800"></textarea>
            </label>

            <button id="submitBtn" type="submit">Generar cartera</button>
            <p id="status" class="status" role="status" aria-live="polite"></p>
          </form>
        </article>

        <article class="panel">
          <div id="output" class="output-box">Completa el formulario para generar una simulación.</div>
          <p class="disclaimer">Simulación educativa. No es asesoría financiera.</p>
        </article>
      </section>
    </main>

    <script>
      const form = document.getElementById("portfolioForm");
      const button = document.getElementById("submitBtn");
      const statusEl = document.getElementById("status");
      const outputEl = document.getElementById("output");

      const clpFormatter = new Intl.NumberFormat("es-CL", {
        style: "currency",
        currency: "CLP",
        maximumFractionDigits: 0,
      });

      function escapeHtml(value) {
        return String(value)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/\"/g, "&quot;")
          .replace(/'/g, "&#39;");
      }

      function renderPortfolio(portfolio) {
        const resumen = portfolio?.resumenEjecutivo;
        const metricas = portfolio?.metricas || {};
        const asignacion = Array.isArray(portfolio?.asignacion) ? portfolio.asignacion : [];
        const riesgos = Array.isArray(portfolio?.riesgosChile) ? portfolio.riesgosChile : [];
        const rebalanceo = portfolio?.rebalanceo || {};

        const rows = asignacion
          .map((item) => {
            const monto = Number(item?.montoCLP);
            const porcentaje = Number(item?.porcentaje);
            return `
              <tr>
                <td>${escapeHtml(item?.ticker ?? "-")}</td>
                <td>${escapeHtml(item?.empresa ?? "-")}</td>
                <td>${escapeHtml(item?.sector ?? "-")}</td>
                <td>${Number.isFinite(porcentaje) ? `${porcentaje}%` : "-"}</td>
                <td>${escapeHtml(item?.rol ?? "-")}</td>
                <td>${Number.isFinite(monto) ? clpFormatter.format(monto) : "-"}</td>
              </tr>
            `;
          })
          .join("");

        const riesgosHtml = riesgos
          .map((riesgo) => `<li>${escapeHtml(riesgo)}</li>`)
          .join("");

        outputEl.innerHTML = `
          <section class="section">
            <h2 class="section-title">Resumen ejecutivo</h2>
            <p>${escapeHtml(resumen || "No se recibió resumen ejecutivo.")}</p>
          </section>

          <section class="section">
            <h2 class="section-title">Métricas estimadas</h2>
            <p><strong>Rentabilidad esperada:</strong> ${escapeHtml(
              metricas?.rentabilidadEsperadaRango || "No disponible"
            )}</p>
            <p><strong>Volatilidad estimada:</strong> ${escapeHtml(
              metricas?.volatilidadEstimadaRango || "No disponible"
            )}</p>
          </section>

          <section class="section">
            <h2 class="section-title">Asignación</h2>
            ${
              asignacion.length
                ? `
                  <table>
                    <thead>
                      <tr>
                        <th>Ticker</th>
                        <th>Empresa</th>
                        <th>Sector</th>
                        <th>%</th>
                        <th>Rol</th>
                        <th>Monto (CLP)</th>
                      </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                  </table>
                `
                : '<p class="muted">No se recibió una asignación válida para mostrar.</p>'
            }
          </section>

          <section class="section">
            <h2 class="section-title">Riesgos principales en Chile</h2>
            ${
              riesgos.length
                ? `<ol>${riesgosHtml}</ol>`
                : '<p class="muted">No se recibieron riesgos específicos.</p>'
            }
          </section>

          <section class="section">
            <h2 class="section-title">Rebalanceo sugerido</h2>
            <p><strong>Frecuencia:</strong> ${escapeHtml(rebalanceo?.frecuencia || "No disponible")}</p>
            <p><strong>Regla:</strong> ${escapeHtml(rebalanceo?.regla || "No disponible")}</p>
            <p><strong>Comentario:</strong> ${escapeHtml(rebalanceo?.comentario || "No disponible")}</p>
          </section>
        `;
      }

      form.addEventListener("submit", async (event) => {
        event.preventDefault();

        const payload = {
          capital: form.capital.value.trim(),
          horizon: form.horizon.value.trim(),
          risk: form.risk.value,
          objective: form.objective.value.trim(),
          constraints: form.constraints.value.trim(),
        };

        button.disabled = true;
        button.textContent = "Generando...";
        statusEl.className = "status";
        statusEl.textContent = "Consultando simulación...";
        outputEl.textContent = "Cargando resultado...";

        try {
          const response = await fetch("/api/recommend", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          const result = await response.json();

          if (!response.ok || result?.ok === false) {
            throw new Error(result?.error || "No fue posible generar la cartera.");
          }

          renderPortfolio(result?.data || {});
          statusEl.textContent = "Simulación generada.";
        } catch (error) {
          statusEl.className = "status error";
          statusEl.textContent = error.message || "Error inesperado.";
          outputEl.textContent = "No se pudo generar la simulación en este momento.";
        } finally {
          button.disabled = false;
          button.textContent = "Generar cartera";
        }
      });
    </script>
  </body>
</html>
