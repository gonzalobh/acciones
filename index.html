<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cartera Acciones Chile — MVP</title>
    <style>
      :root {
        color-scheme: light;
        --bg: #ffffff;
        --text: #111111;
        --muted: #666666;
        --border: #eaeaea;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        padding: 40px 20px;
        background: var(--bg);
        color: var(--text);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial,
          sans-serif;
        line-height: 1.45;
      }

      .container {
        max-width: 1080px;
        margin: 0 auto;
      }

      h1 {
        margin: 0 0 24px;
        font-size: clamp(1.4rem, 2.5vw, 2rem);
        font-weight: 600;
        letter-spacing: -0.02em;
      }

      .grid {
        display: grid;
        grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
        gap: 20px;
      }

      .panel {
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 20px;
        background: #fff;
      }

      form {
        display: grid;
        gap: 14px;
      }

      label {
        display: grid;
        gap: 6px;
        font-size: 0.9rem;
        font-weight: 500;
      }

      input,
      select,
      textarea,
      button {
        width: 100%;
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 12px;
        background: #fff;
        color: var(--text);
        font: inherit;
      }

      textarea {
        min-height: 92px;
        resize: vertical;
      }

      input:focus,
      select:focus,
      textarea:focus,
      button:focus {
        outline: 2px solid #000;
        outline-offset: 1px;
      }

      button {
        cursor: pointer;
        font-weight: 600;
      }

      button[disabled] {
        cursor: not-allowed;
        opacity: 0.6;
      }

      .status {
        min-height: 20px;
        margin: 8px 0 0;
        font-size: 0.85rem;
      }

      .status.error {
        color: #000;
        font-weight: 600;
      }

      .output-box {
        margin: 0;
        min-height: 420px;
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 16px;
        overflow-x: auto;
      }

      .section {
        margin-top: 28px;
        padding-top: 12px;
        border-top: 1px solid #e5e5e5;
      }

      .section-title {
        font-weight: 600;
        margin-bottom: 8px;
      }

      p,
      li,
      td,
      th {
        font-size: 0.92rem;
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      th,
      td {
        border: 1px solid var(--border);
        text-align: left;
        padding: 8px;
        vertical-align: top;
      }

      th {
        font-weight: 600;
      }

      ol {
        margin: 0;
        padding-left: 20px;
      }

      .muted {
        color: var(--muted);
      }

      .disclaimer {
        margin: 12px 0 0;
        font-size: 0.8rem;
        color: var(--muted);
      }

      @media (max-width: 840px) {
        body {
          padding: 24px 14px;
        }

        .grid {
          grid-template-columns: 1fr;
        }

        .output-box {
          min-height: 320px;
        }
      }
    </style>
  </head>
  <body>
    <main class="container">
      <h1>Cartera Acciones Chile — MVP</h1>

      <section class="grid">
        <article class="panel">
          <form id="portfolioForm">
            <label>
              Capital (CLP)
              <input id="capital" name="capital" type="number" min="1" step="1" required />
            </label>

            <label>
              Horizonte de inversión (años)
              <input id="horizon" name="horizon" type="number" min="1" step="1" required />
            </label>

            <label>
              Nivel de riesgo
              <select id="risk" name="risk" required>
                <option value="">Selecciona nivel</option>
                <option value="Bajo">Bajo</option>
                <option value="Medio">Medio</option>
                <option value="Medio-Alto">Medio-Alto</option>
                <option value="Alto">Alto</option>
              </select>
            </label>

            <label>
              Objetivo
              <input id="objective" name="objective" type="text" maxlength="200" required />
            </label>

            <label>
              Restricciones opcionales
              <textarea id="constraints" name="constraints" maxlength="800"></textarea>
            </label>

            <button id="submitBtn" type="submit">Generar cartera</button>
            <p id="status" class="status" role="status" aria-live="polite"></p>
          </form>
        </article>

        <article class="panel">
          <div id="output" class="output-box">Completa el formulario para generar una simulación.</div>
          <p class="disclaimer">Simulación educativa. No es asesoría financiera.</p>
        </article>
      </section>
    </main>

    <script>
      const form = document.getElementById("portfolioForm");
      const button = document.getElementById("submitBtn");
      const statusEl = document.getElementById("status");
      const outputEl = document.getElementById("output");


      function escapeHtml(value) {
        return String(value)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/\"/g, "&quot;")
          .replace(/'/g, "&#39;");
      }

      function renderPortfolio(portfolio) {
        const data = portfolio || {};
        const asignacion = Array.isArray(data?.asignacion) ? data.asignacion : [];
        const logicaCartera = Array.isArray(data?.logicaCartera) ? data.logicaCartera : [];
        const asignacionSectorial = Array.isArray(data?.asignacionSectorial)
          ? data.asignacionSectorial
          : [];
        const riesgosPrincipales = Array.isArray(data?.riesgosPrincipales) ? data.riesgosPrincipales : [];
        const monitoreo = data?.monitoreo || {};
        const estimaciones = data?.estimaciones || {};

        const rows = asignacion
          .map((item) => {
            const porcentaje = Number(item?.porcentaje);
            return `
              <tr>
                <td>${escapeHtml(item?.accion ?? "-")}</td>
                <td>${escapeHtml(item?.ticker ?? "-")}</td>
                <td>${escapeHtml(item?.sector ?? "-")}</td>
                <td>${Number.isFinite(porcentaje) ? `${porcentaje}%` : "-"}</td>
                <td>${escapeHtml(item?.rol ?? "-")}</td>
              </tr>
            `;
          })
          .join("");

        let html = "";

        html += `
<div class="section">
  <div class="section-title">Resumen ejecutivo</div>
  <p>${escapeHtml(data.resumenEjecutivo || "No se recibió resumen ejecutivo.")}</p>
</div>

<div class="section">
  <div class="section-title">Supuestos macro</div>
  <p>${escapeHtml(data.supuestosMacro || "No se recibieron supuestos macro.")}</p>
</div>
`;

        html += `
<div class="section">
  <div class="section-title">Asignación</div>
  ${
    asignacion.length
      ? `
        <table>
          <thead>
            <tr>
              <th>Acción</th>
              <th>Ticker</th>
              <th>Sector</th>
              <th>%</th>
              <th>Rol</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      `
      : '<p class="muted">No se recibió una asignación válida para mostrar.</p>'
  }
</div>
`;

        html += `<div class="section">
<div class="section-title">Lógica de la cartera</div>`;

        if (logicaCartera.length) {
          logicaCartera.forEach((b) => {
            html += `<p><strong>${escapeHtml(b?.bloque ?? "-")}</strong><br>${escapeHtml(
              b?.descripcion ?? "-"
            )}</p>`;
          });
        } else {
          html += `<p class="muted">No se recibió una lógica de cartera detallada.</p>`;
        }

        html += `</div>`;

        html += `<div class="section">
<div class="section-title">Asignación por sector</div>
<ul>`;

        if (asignacionSectorial.length) {
          asignacionSectorial.forEach((s) => {
            html += `<li>${escapeHtml(s?.sector ?? "-")}: ${escapeHtml(s?.porcentaje ?? "-")}%</li>`;
          });
        } else {
          html += `<li class="muted">No se recibió asignación sectorial.</li>`;
        }

        html += `</ul></div>`;

        html += `<div class="section">
<div class="section-title">Estimaciones</div>
<p><strong>Rentabilidad esperada:</strong> ${escapeHtml(
          estimaciones?.rentabilidadEsperada || "No disponible"
        )}</p>
<p><strong>Volatilidad:</strong> ${escapeHtml(estimaciones?.volatilidad || "No disponible")}</p>
<p><strong>Drawdown:</strong> ${escapeHtml(estimaciones?.drawdown || "No disponible")}</p>
</div>`;

        html += `<div class="section">
<div class="section-title">Riesgos principales</div>
<ol>`;

        if (riesgosPrincipales.length) {
          riesgosPrincipales.forEach((r) => {
            html += `<li>${escapeHtml(r)}</li>`;
          });
        } else {
          html += `<li class="muted">No se recibieron riesgos principales.</li>`;
        }

        html += `</ol></div>`;

        html += `<div class="section">
<div class="section-title">Monitoreo</div>
<p><strong>Frecuencia:</strong> ${escapeHtml(monitoreo?.frecuencia || "No disponible")}</p>
<p><strong>Qué mirar:</strong></p>
<ul>`;

        if (Array.isArray(monitoreo?.queMirar) && monitoreo.queMirar.length) {
          monitoreo.queMirar.forEach((indicador) => {
            html += `<li>${escapeHtml(indicador)}</li>`;
          });
        } else {
          html += `<li class="muted">No se recibieron indicadores de seguimiento.</li>`;
        }

        html += `</ul></div>`;

        html += `
<div class="section">
  <div class="section-title">Sugerencia de implementación</div>
  <p>${escapeHtml(data.implementacion || "No se recibió una guía de implementación.")}</p>
</div>
`;

        outputEl.innerHTML = html;
      }

      form.addEventListener("submit", async (event) => {
        event.preventDefault();

        const payload = {
          capital: form.capital.value.trim(),
          horizon: form.horizon.value.trim(),
          risk: form.risk.value,
          objective: form.objective.value.trim(),
          constraints: form.constraints.value.trim(),
        };

        button.disabled = true;
        button.textContent = "Generando...";
        statusEl.className = "status";
        statusEl.textContent = "Consultando simulación...";
        outputEl.textContent = "Cargando resultado...";

        try {
          const response = await fetch("/api/recommend", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          const result = await response.json();

          if (!response.ok || result?.ok === false) {
            throw new Error(result?.error || "No fue posible generar la cartera.");
          }

          renderPortfolio(result?.data || {});
          statusEl.textContent = "Simulación generada.";
        } catch (error) {
          statusEl.className = "status error";
          statusEl.textContent = error.message || "Error inesperado.";
          outputEl.textContent = "No se pudo generar la simulación en este momento.";
        } finally {
          button.disabled = false;
          button.textContent = "Generar cartera";
        }
      });
    </script>
  </body>
</html>
